<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=false><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=theme-color><title>Patterns and Practices for using SQLAlchemy 2.0 with FastAPI &#183; tobiwan.dev</title><meta name=title content="Patterns and Practices for using SQLAlchemy 2.0 with FastAPI &#183; tobiwan.dev"><meta name=description content="My personal website and blog about backend engineering"><meta name=keywords content="python,"><link rel=canonical href=https://ttyobiwan.github.io/articles/fastapi-sqlalchemy/><link type=text/css rel=stylesheet href=/css/main.bundle.min.1543cfd617bf2821b25269be3a67d06424c5f70c6eba4d8d496d399e25ca63e237cc443af4976f3dcb68c872dfbab55b2eac7d248a61c4cbfa95183663c80eeb.css integrity="sha512-FUPP1he/KCGyUmm+OmfQZCTF9wxuuk2NSW05niXKY+I3zEQ69JdvPctoyHLfurVbLqx9JIphxMv6lRg2Y8gO6w=="><script type=text/javascript src=/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj+e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.f99aa39bcfb5d16a28ec2236bd358df5e465058a67f58b42534a3b15882a6a3513791fd27248c6b5b5cef06337f714070d4784fb776f44d930309b64cce1a2e0.js integrity="sha512-+Zqjm8+10Woo7CI2vTWN9eRlBYpn9YtCU0o7FYgqajUTeR/SckjGtbXO8GM39xQHDUeE+3dvRNkwMJtkzOGi4A==" data-copy=Copy data-copied=Copied></script><script src=/lib/zoom/zoom.min.umd.a527109b68c082a70f3697716dd72a9d5aa8b545cf800cecbbc7399f2ca6f6e0ce3e431f2062b48bbfa47c9ea42822714060bef309be073f49b9c0e30d318d7b.js integrity="sha512-pScQm2jAgqcPNpdxbdcqnVqotUXPgAzsu8c5nyym9uDOPkMfIGK0i7+kfJ6kKCJxQGC+8wm+Bz9JucDjDTGNew=="></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:url" content="https://ttyobiwan.github.io/articles/fastapi-sqlalchemy/"><meta property="og:site_name" content="tobiwan.dev"><meta property="og:title" content="Patterns and Practices for using SQLAlchemy 2.0 with FastAPI"><meta property="og:description" content="While Django and Flask remain the first choices for many Python engineers, FastAPI has already been recognized as an undeniably reliable pick. It is a highly flexible, well-optimized, structured framework that gives the developer endless possibilities for building backend applications.
Working with databases is an essential aspect of most backend applications. As a result, the ORM plays a critical role in the backend code. However, unlike Django, FastAPI does not have an ORM built-in. It is entirely the developer’s responsibility to select a suitable library and integrate it into the codebase."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="articles"><meta property="article:published_time" content="2023-06-15T00:00:00+00:00"><meta property="article:modified_time" content="2023-06-15T00:00:00+00:00"><meta property="article:tag" content="Python"><meta property="og:image" content="https://ttyobiwan.github.io/articles/fastapi-sqlalchemy/featured.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://ttyobiwan.github.io/articles/fastapi-sqlalchemy/featured.png"><meta name=twitter:title content="Patterns and Practices for using SQLAlchemy 2.0 with FastAPI"><meta name=twitter:description content="While Django and Flask remain the first choices for many Python engineers, FastAPI has already been recognized as an undeniably reliable pick. It is a highly flexible, well-optimized, structured framework that gives the developer endless possibilities for building backend applications.
Working with databases is an essential aspect of most backend applications. As a result, the ORM plays a critical role in the backend code. However, unlike Django, FastAPI does not have an ORM built-in. It is entirely the developer’s responsibility to select a suitable library and integrate it into the codebase."><meta name=twitter:image content="https://ttyobiwan.github.io/articles/fastapi-sqlalchemy/featured.png"><meta property="og:image" content="https://ttyobiwan.github.io/articles/fastapi-sqlalchemy/featured.png"><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Articles","name":"Patterns and Practices for using SQLAlchemy 2.0 with FastAPI","headline":"Patterns and Practices for using SQLAlchemy 2.0 with FastAPI","abstract":"\u003cp\u003eWhile Django and Flask remain the first choices for many Python engineers, \u003cstrong\u003eFastAPI\u003c\/strong\u003e has already been recognized as an undeniably reliable pick. It is a highly flexible, well-optimized, structured framework that gives the developer endless possibilities for building backend applications.\u003c\/p\u003e\n\u003cp\u003eWorking with databases is an essential aspect of most backend applications. As a result, the ORM plays a critical role in the backend code. However, unlike Django, FastAPI does not have an ORM built-in. It is entirely the developer\u0026rsquo;s responsibility to select a suitable library and integrate it into the codebase.\u003c\/p\u003e","inLanguage":"en","url":"https:\/\/ttyobiwan.github.io\/articles\/fastapi-sqlalchemy\/","author":{"@type":"Person","name":"Piotr Tobiasz"},"copyrightYear":"2023","dateCreated":"2023-06-15T00:00:00\u002b00:00","datePublished":"2023-06-15T00:00:00\u002b00:00","dateModified":"2023-06-15T00:00:00\u002b00:00","keywords":["python"],"mainEntityOfPage":"true","wordCount":"4117"}]</script><meta name=author content="Piotr Tobiasz"><link href=https://github.com/ttyobiwan rel=me><link href=https://linkedin.com/in/piotr-tobiasz-dev rel=me><script src=/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj+KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script><link rel=stylesheet href=/css/repo-cards.min.4ae5b5ba58e47eec6bb063f962002d0f9a2f9a1ab4f2d399a027aa800787524b1451e0a48893370c0b98a9d1f01078d0903ad5b4940c0f0a358ca43f9055e6b0.css integrity="sha512-SuW1uljkfuxrsGP5YgAtD5ovmhq08tOZoCeqgAeHUksUUeCkiJM3DAuYqdHwEHjQkDrVtJQMDwo1jKQ/kFXmsA=="></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 pe-2 dark:text-primary-400">&darr;</span>
Skip to main content</a></div><div class=min-h-[148px]></div><div class="fixed inset-x-0 pl-[24px] pr-[24px] z-100"><div id=menu-blur class="absolute opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl shadow-2xl"></div><div class="relative max-w-[64rem] ml-auto mr-auto"><div class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start gap-x-3 pt-[2px] pr-0 pb-[3px] pl-0"><div><a href=/ class=flex><span class=sr-only>tobiwan.dev</span>
<img src=/img/keanu.png width=25 height=25 class="logo max-h-[5rem] max-w-[5rem] object-scale-down object-left nozoom" alt=tobiwan.dev></a></div><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/ class="text-base font-medium">tobiwan.dev</a></nav><nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12"><a href=/articles/ class="flex items-center hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title=Articles>Articles</p></a><a href=/about/ class="flex items-center hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title=About>About</p></a><button id=search-button aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="Search (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button><div class="flex items-center"><button id=appearance-switcher aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></nav><div class="flex md:hidden items-center gap-x-5 md:ml-12 h-12"><span></span>
<button id=search-button-mobile aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="Search (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></button>
<button id=appearance-switcher-mobile aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400 me-1"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></div><div class="-my-2 md:hidden"><div id=menu-button class=block><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50 pt-[5px]"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none text-end max-w-7xl"><li id=menu-close-button><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class=mt-1><a href=/articles/ class="flex items-center hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title=Articles>Articles</p></a></li><li class=mt-1><a href=/about/ class="flex items-center hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title=About>About</p></a></li></ul></div></div></div></div></div></div><script type=text/javascript src=/js/background-blur.min.00a57c73ea12f2cab2980c3c3d649e89f6d82f190f74bbe2b67f2f5e39ab7d032ece47086400ca05396758aace13299da49aca43ea643d2625e62c506267a169.js integrity="sha512-AKV8c+oS8sqymAw8PWSeifbYLxkPdLvitn8vXjmrfQMuzkcIZADKBTlnWKrOEymdpJrKQ+pkPSYl5ixQYmehaQ==" data-blur-id=menu-blur></script><div class="relative flex flex-col grow"><main id=main-content class=grow><article><div id=hero class="h-[150px] md:h-[200px]"></div><div class="fixed inset-x-0 top-0 h-[800px] single_hero_background nozoom"><img id=background-image src=/articles/fastapi-sqlalchemy/featured_hu_eae47a38ef3573bc.png alt="Background Image" class="absolute inset-0 w-full h-full object-cover"><div class="absolute inset-0 bg-gradient-to-t from-neutral dark:from-neutral-800 to-transparent mix-blend-normal"></div><div class="absolute inset-0 opacity-60 bg-gradient-to-t from-neutral dark:from-neutral-800 to-neutral-100 dark:to-neutral-800 mix-blend-normal"></div></div><div id=background-blur class="fixed opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl"></div><script type=text/javascript src=/js/background-blur.min.00a57c73ea12f2cab2980c3c3d649e89f6d82f190f74bbe2b67f2f5e39ab7d032ece47086400ca05396758aace13299da49aca43ea643d2625e62c506267a169.js integrity="sha512-AKV8c+oS8sqymAw8PWSeifbYLxkPdLvitn8vXjmrfQMuzkcIZADKBTlnWKrOEymdpJrKQ+pkPSYl5ixQYmehaQ==" data-blur-id=background-blur data-image-id=background-image data-image-url=/articles/fastapi-sqlalchemy/featured.png></script><header id=single_header class="mt-5 max-w-prose"><ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden"><li class=hidden><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/>tobiwan.dev</a><span class="px-1 text-primary-500">/</span></li><li class=inline><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/articles/>Articles</a><span class="px-1 text-primary-500">/</span></li><li class=hidden><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/articles/fastapi-sqlalchemy/>Patterns and Practices for using SQLAlchemy 2.0 with FastAPI</a><span class="px-1 text-primary-500">/</span></li></ol><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Patterns and Practices for using SQLAlchemy 2.0 with FastAPI</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2023-06-15T00:00:00+00:00>15 June 2023</time><span class="px-2 text-primary-500">&#183;</span><span>4117 words</span><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">20 mins</span></div><div class="flex flex-row flex-wrap items-center"><a class="relative mt-[0.5rem] me-2" href=/tags/python/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Python</span></span></a></div></div><div class="flex author author-extra mt-4"><img class="!mt-0 !mb-0 h-24 w-24 rounded-full me-4" width=96 height=96 src=/img/profile_hu_bf308c3f4f6472a1.png><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">Author</div><a href=https://ttyobiwan.github.io/authors/piotr/ class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">Piotr Tobiasz</a><div class="text-sm text-neutral-700 dark:text-neutral-400">Engineering enjoyer, doing backend stuff with Go, Python and Elixir</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=mailto:piotr.tobiasz.it@gmail.com target=_blank aria-label=Email rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://github.com/ttyobiwan target=_blank aria-label=Github rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://linkedin.com/in/piotr-tobiasz-dev target=_blank aria-label=Linkedin rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg></span></span></a></div></div></div></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first lg:ml-auto px-0 lg:order-last lg:ps-8"><div class="toc ps-5 print:hidden lg:sticky lg:top-[140px]"><details open id=TOCView class="toc-right mt-0 overflow-y-auto overscroll-contain scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600 rounded-lg -ms-5 ps-5 pe-2 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="min-w-[220px] py-2 border-dotted border-s-1 -ms-5 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#prerequisites>Prerequisites</a></li><li><a href=#api-requirements>API requirements</a></li><li><a href=#declaring-models>Declaring models</a></li><li><a href=#session-handler>Session handler</a></li><li><a href=#quick-migrations>Quick migrations</a></li><li><a href=#api-with-the-orm>API with the ORM</a></li><li><a href=#repository>Repository</a></li><li><a href=#testing>Testing</a></li><li><a href=#summary>Summary</a></li><li><a href=#sources>Sources</a></li></ul></nav></div></details><details class="toc-inside mt-0 overflow-hidden rounded-lg -ms-5 ps-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="py-2 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#prerequisites>Prerequisites</a></li><li><a href=#api-requirements>API requirements</a></li><li><a href=#declaring-models>Declaring models</a></li><li><a href=#session-handler>Session handler</a></li><li><a href=#quick-migrations>Quick migrations</a></li><li><a href=#api-with-the-orm>API with the ORM</a></li><li><a href=#repository>Repository</a></li><li><a href=#testing>Testing</a></li><li><a href=#summary>Summary</a></li><li><a href=#sources>Sources</a></li></ul></nav></div></details></div></div><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><p>While Django and Flask remain the first choices for many Python engineers, <strong>FastAPI</strong> has already been recognized as an undeniably reliable pick. It is a highly flexible, well-optimized, structured framework that gives the developer endless possibilities for building backend applications.</p><p>Working with databases is an essential aspect of most backend applications. As a result, the ORM plays a critical role in the backend code. However, unlike Django, FastAPI does not have an ORM built-in. It is entirely the developer&rsquo;s responsibility to select a suitable library and integrate it into the codebase.</p><p>Python engineers widely consider <strong>SQLAlchemy</strong> to be the most popular ORM available. It&rsquo;s a legendary library that&rsquo;s been in use since 2006 and has been adopted by thousands of projects. In 2023, it received a major update to version 2.0. Similar to FastAPI, SQLAlchemy provides developers with powerful features and utilities without forcing them to use them in a specific way. Essentially, it&rsquo;s a versatile toolkit that empowers developers to use it however they see fit.</p><p>FastAPI and SQLAlchemy are a match made in heaven. They are both reliable, performant, and modern technologies, which enable the creation of powerful and unique applications. This article explores creating a FastAPI backend application that utilizes SQLAlchemy 2.0 as the ORM. The content covers:</p><ul><li>building models using <code>Mapped</code> and <code>mapped_column</code></li><li>defining an abstract model</li><li>handling database session</li><li>using the ORM</li><li>creating a common repository class for all models</li><li>preparing a test setup and adding tests</li></ul><p>Afterward, you will be able to combine the FastAPI application with SQLAlchemy ORM easily. Additionally, you will get familiar with best practices and patterns for creating well-structured, robust, and performant applications.</p><h2 class="relative group">Prerequisites<div id=prerequisites class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#prerequisites aria-label=Anchor>#</a></span></h2><p>Code examples included in the article come from the <strong><em>alchemist</em></strong> project, which is a basic API for creating and reading ingredient and potion objects. The main focus of the article is to explore the combination of FastAPI and SQLAlchemy. It doesn&rsquo;t cover other topics, such as:</p><ul><li>configuring Docker setup</li><li>starting the uvicorn server</li><li>setting up linting</li></ul><p>If you are interested in these topics, you can explore them on your own by examining the codebase. To access the code repository of the alchemist project, please follow this link <a href=https://github.com/ttyobiwan/alchemist target=_blank>here</a>. Additionally, you can find the file structure of the project below:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>alchemist
</span></span><span style=display:flex><span>├─ alchemist
</span></span><span style=display:flex><span>│  ├─ api
</span></span><span style=display:flex><span>│  │  ├─ v1
</span></span><span style=display:flex><span>│  │  │  ├─ __init__.py
</span></span><span style=display:flex><span>│  │  │  └─ routes.py
</span></span><span style=display:flex><span>│  │  ├─ v2
</span></span><span style=display:flex><span>│  │  │  ├─ __init__.py
</span></span><span style=display:flex><span>│  │  │  ├─ dependencies.py
</span></span><span style=display:flex><span>│  │  │  └─ routes.py
</span></span><span style=display:flex><span>│  │  ├─ __init__.py
</span></span><span style=display:flex><span>│  │  └─ models.py
</span></span><span style=display:flex><span>│  ├─ database
</span></span><span style=display:flex><span>│  │  ├─ __init__.py
</span></span><span style=display:flex><span>│  │  ├─ models.py
</span></span><span style=display:flex><span>│  │  ├─ repository.py
</span></span><span style=display:flex><span>│  │  └─ session.py
</span></span><span style=display:flex><span>│  ├─ __init__.py
</span></span><span style=display:flex><span>│  ├─ app.py
</span></span><span style=display:flex><span>│  └─ config.py
</span></span><span style=display:flex><span>├─ requirements
</span></span><span style=display:flex><span>│  ├─ base.txt
</span></span><span style=display:flex><span>│  └─ dev.txt
</span></span><span style=display:flex><span>├─ scripts
</span></span><span style=display:flex><span>│  ├─ create_test_db.sh
</span></span><span style=display:flex><span>│  ├─ migrate.py
</span></span><span style=display:flex><span>│  └─ run.sh
</span></span><span style=display:flex><span>├─ tests
</span></span><span style=display:flex><span>│  ├─ conftest.py
</span></span><span style=display:flex><span>│  └─ test_api.py
</span></span><span style=display:flex><span>├─ .env
</span></span><span style=display:flex><span>├─ .gitignore
</span></span><span style=display:flex><span>├─ .pre-commit-config.yaml
</span></span><span style=display:flex><span>├─ Dockerfile
</span></span><span style=display:flex><span>├─ Makefile
</span></span><span style=display:flex><span>├─ README.md
</span></span><span style=display:flex><span>├─ docker-compose.yaml
</span></span><span style=display:flex><span>├─ example.env
</span></span><span style=display:flex><span>└─ pyproject.toml
</span></span></code></pre></div><p>Although the tree may seem large, some of the contents are not relevant to the main point of this article. Additionally, the code may appear simpler than what is necessary in certain areas. For instance, the project lacks:</p><ul><li>production stage in the Dockerfile</li><li>alembic setup for migrations</li><li>subdirectories for tests</li></ul><p>This was done intentionally to reduce complexity and avoid unnecessary overhead. However, it is important to keep these factors in mind if dealing with a more production-ready project.</p><h2 class="relative group">API requirements<div id=api-requirements class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#api-requirements aria-label=Anchor>#</a></span></h2><p>When beginning to develop an app, it&rsquo;s critical to consider the models that your app will use. These models will represent the <strong>objects</strong> and <strong>entities</strong> that your app will work with and will be exposed in the API. In the case of the alchemist app, there are two entities: ingredients and potions. The API should allow for creating, and retrieving these entities. The <code>alchemist/api/models.py</code> file contains the models that will be used in the API:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> uuid
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pydantic <span style=color:#f92672>import</span> BaseModel, Field
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Ingredient</span>(BaseModel):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;Ingredient model.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    pk: uuid<span style=color:#f92672>.</span>UUID
</span></span><span style=display:flex><span>    name: str
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Config</span>:
</span></span><span style=display:flex><span>        orm_mode <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>IngredientPayload</span>(BaseModel):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;Ingredient payload model.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    name: str <span style=color:#f92672>=</span> Field(min_length<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>, max_length<span style=color:#f92672>=</span><span style=color:#ae81ff>127</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Potion</span>(BaseModel):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;Potion model.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    pk: uuid<span style=color:#f92672>.</span>UUID
</span></span><span style=display:flex><span>    name: str
</span></span><span style=display:flex><span>    ingredients: list[Ingredient]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Config</span>:
</span></span><span style=display:flex><span>        orm_mode <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PotionPayload</span>(BaseModel):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;Potion payload model.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    name: str <span style=color:#f92672>=</span> Field(min_length<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>, max_length<span style=color:#f92672>=</span><span style=color:#ae81ff>127</span>)
</span></span><span style=display:flex><span>    ingredients: list[uuid<span style=color:#f92672>.</span>UUID] <span style=color:#f92672>=</span> Field(min_items<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
</span></span></code></pre></div><p>The API will be returning <code>Ingredient</code> and <code>Potion</code> models. Setting <code>orm_mode</code> to <code>True</code> in the configuration will make it easier to work with the SQLAlchemy objects in the future. <code>Payload</code> models will be utilized for creating new objects.</p><p>The use of pydantic makes the classes more detailed and clear in their roles and functions. Now, it&rsquo;s time to create the database models.</p><h2 class="relative group">Declaring models<div id=declaring-models class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#declaring-models aria-label=Anchor>#</a></span></h2><p>A model is essentially a <strong>representation</strong> of something. In the context of APIs, models represent what the backend expects in the request body and what it will return in the response data. Database models, on the other hand, are more complex and represent the <strong>data structures</strong> stored in the database and the <strong>relationship</strong> types between them.</p><p>The <code>alchemist/database/models.py</code> file contains models for ingredient and potion objects:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> uuid
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> sqlalchemy <span style=color:#f92672>import</span> Column, ForeignKey, Table, orm
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> sqlalchemy.dialects.postgresql <span style=color:#f92672>import</span> UUID
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Base</span>(orm<span style=color:#f92672>.</span>DeclarativeBase):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;Base database model.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    pk: orm<span style=color:#f92672>.</span>Mapped[uuid<span style=color:#f92672>.</span>UUID] <span style=color:#f92672>=</span> orm<span style=color:#f92672>.</span>mapped_column(
</span></span><span style=display:flex><span>        primary_key<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>,
</span></span><span style=display:flex><span>        default<span style=color:#f92672>=</span>uuid<span style=color:#f92672>.</span>uuid4,
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>potion_ingredient_association <span style=color:#f92672>=</span> Table(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;potion_ingredient&#34;</span>,
</span></span><span style=display:flex><span>    Base<span style=color:#f92672>.</span>metadata,
</span></span><span style=display:flex><span>    Column(<span style=color:#e6db74>&#34;potion_id&#34;</span>, UUID(as_uuid<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>), ForeignKey(<span style=color:#e6db74>&#34;potion.pk&#34;</span>)),
</span></span><span style=display:flex><span>    Column(<span style=color:#e6db74>&#34;ingredient_id&#34;</span>, UUID(as_uuid<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>), ForeignKey(<span style=color:#e6db74>&#34;ingredient.pk&#34;</span>)),
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Ingredient</span>(Base):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;Ingredient database model.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    __tablename__ <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ingredient&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    name: orm<span style=color:#f92672>.</span>Mapped[str]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Potion</span>(Base):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;Potion database model.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    __tablename__ <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;potion&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    name: orm<span style=color:#f92672>.</span>Mapped[str]
</span></span><span style=display:flex><span>    ingredients: orm<span style=color:#f92672>.</span>Mapped[list[<span style=color:#e6db74>&#34;Ingredient&#34;</span>]] <span style=color:#f92672>=</span> orm<span style=color:#f92672>.</span>relationship(
</span></span><span style=display:flex><span>        secondary<span style=color:#f92672>=</span>potion_ingredient_association,
</span></span><span style=display:flex><span>        backref<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;potions&#34;</span>,
</span></span><span style=display:flex><span>        lazy<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;selectin&#34;</span>,
</span></span><span style=display:flex><span>    )
</span></span></code></pre></div><p>Every model in SQLAlchemy starts with the <code>DeclarativeBase</code> class. Inheriting from it allows building database models that are compatible with Python type checkers.</p><p>It&rsquo;s also a good practice to create an <strong>abstract</strong> model—<code>Base</code> class in this case—that includes fields required in all models. These fields include the primary key, which is a unique identifier of every object. The abstract model often also stores the creation and update dates of an object, which are set automatically, when an object is created or updated. However, the <code>Base</code> model will be kept simple.</p><p>Moving on to the <code>Ingredient</code> model, the <code>__tablename__</code> attribute specifies the name of the database table, while the <code>name</code> field uses the new SQLAlchemy syntax, allowing model fields to be declared with type annotations. This concise and modern approach is both powerful and advantageous for type checkers and IDEs, as it recognizes the <code>name</code> field as a string.</p><p>Things get more complex in the <code>Potion</code> model. It also includes <code>__tablename__</code> and <code>name</code> attributes, but on top of that, it stores the relationship to ingredients. The use of <code>Mapped[list["Ingredient"]]</code> indicates that the potion can contain multiple ingredients, and in this case, the relationship is many-to-many (M2M). This means that a single ingredient can be assigned to multiple potions.</p><p>M2M requires additional configuration, usually involving the creation of an association table that stores the connections between the two entities. In this case, the <code>potion_ingredient_association</code> object stores only the identifiers of the ingredient and potion, but it could also include extra attributes, such as the amount of a specific ingredient needed for the potion.</p><p>The <code>relationship</code> function configures the relationship between the potion and its ingredients. The <code>lazy</code> argument specifies how related items should be loaded. In other words: what should SQLAlchemy do with related ingredients when you are fetching a potion. Setting it to <code>selectin</code> means that ingredients will be loaded with the potion, eliminating the need for additional queries in the code.</p><p>Building well-designed models is crucial when working with an ORM. Once this is done, the next step is establishing the connection with the database.</p><h2 class="relative group">Session handler<div id=session-handler class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#session-handler aria-label=Anchor>#</a></span></h2><p>When working with a database, particularly when using SQLAlchemy, it is essential to understand the following concepts:</p><ul><li>dialect</li><li>engine</li><li>connection</li><li>connection pool</li><li>session</li></ul><p>Out of all these terms, the most important one is the <em><strong>engine</strong></em>. According to the SQLAlchemy documentation, the engine object is responsible for connecting the <code>Pool</code> and <code>Dialect</code> to facilitate database connectivity and behavior. In simpler terms, the engine object is the source of the database connection, while the <em><strong>connection</strong></em> provides high-level functionalities like executing SQL statements, managing transactions, and retrieving results from the database.</p><p>A <em><strong>session</strong></em> is a unit of work that groups related operations within a single transaction. It is an abstraction over the underlying database connections and efficiently manages connections and transactional behavior.</p><p><em><strong>Dialect</strong></em> is a component that provides support for a specific database backend. It acts as an intermediary between SQLAlchemy and the database, handling the details of communication. The alchemist project uses Postgres as the database, so the dialect must be compatible with this specific database type.</p><p>The final question mark is the <em><strong>connection pool</strong></em>. In the context of SQLAlchemy, a connection pool is a mechanism that manages a collection of database connections. It is designed to improve the performance and efficiency of database operations by reusing existing connections rather than creating new ones for each request. By reusing connections, the connection pool reduces the overhead of establishing new connections and tearing them down, resulting in improved performance.</p><p>With that knowledge covered, you can now take a look at <code>alchemist/database/session.py</code> file, which contains a function that will be used as a dependency for connecting to the database:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> collections.abc <span style=color:#f92672>import</span> AsyncGenerator
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> sqlalchemy <span style=color:#f92672>import</span> exc
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> sqlalchemy.ext.asyncio <span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    AsyncSession,
</span></span><span style=display:flex><span>    async_sessionmaker,
</span></span><span style=display:flex><span>    create_async_engine,
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> alchemist.config <span style=color:#f92672>import</span> settings
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_db_session</span>() <span style=color:#f92672>-&gt;</span> AsyncGenerator[AsyncSession, <span style=color:#66d9ef>None</span>]:
</span></span><span style=display:flex><span>    engine <span style=color:#f92672>=</span> create_async_engine(settings<span style=color:#f92672>.</span>DATABASE_URL)
</span></span><span style=display:flex><span>    factory <span style=color:#f92672>=</span> async_sessionmaker(engine)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>with</span> factory() <span style=color:#66d9ef>as</span> session:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>yield</span> session
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>await</span> session<span style=color:#f92672>.</span>commit()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>except</span> exc<span style=color:#f92672>.</span>SQLAlchemyError <span style=color:#66d9ef>as</span> error:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>await</span> session<span style=color:#f92672>.</span>rollback()
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span>
</span></span></code></pre></div><p>The first important detail to notice is that the function <code>get_db_session</code> is a generator function. This is because the FastAPI dependency system supports generators. As a result, this function can handle both successful and failed scenarios.</p><p>The first two lines of the <code>get_db_session</code> function create a database engine and a session. However, the session object can also be used as a context manager. This gives you more control over potential exceptions and successful outcomes.</p><p>Although SQLAlchemy handles the closing of connections, it is a good practice to explicitly declare how to handle the connection after it&rsquo;s done. In the <code>get_db_session</code> function, the session is committed if everything goes well and rolled back if an exception is raised.</p><p>It&rsquo;s important to note that this code is built around the asyncio extension. This feature of SQLAlchemy allows the app to interact with the database asynchronously. It means that requests to the database won&rsquo;t block other API requests, making the app way more efficient.</p><p>Once the models and connection are set up, the next step is to ensure that the models are added to the database.</p><h2 class="relative group">Quick migrations<div id=quick-migrations class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#quick-migrations aria-label=Anchor>#</a></span></h2><p>SQLAlchemy models represent the structures of a database. However, simply creating them does not result in immediate changes to the database. To make changes, you must first <em><strong>apply</strong></em> them. This is typically done using a migration library such as alembic, which tracks every model and updates the database accordingly.</p><p>Since no further changes to the models are planned in this scenario, a basic migration script will suffice. Below is an example code from the <code>scripts/migrate.py</code> file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> asyncio
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> logging
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> sqlalchemy.ext.asyncio <span style=color:#f92672>import</span> create_async_engine
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> alchemist.config <span style=color:#f92672>import</span> settings
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> alchemist.database.models <span style=color:#f92672>import</span> Base
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>logger <span style=color:#f92672>=</span> logging<span style=color:#f92672>.</span>getLogger()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>migrate_tables</span>() <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>    logger<span style=color:#f92672>.</span>info(<span style=color:#e6db74>&#34;Starting to migrate&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    engine <span style=color:#f92672>=</span> create_async_engine(settings<span style=color:#f92672>.</span>DATABASE_URL)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>with</span> engine<span style=color:#f92672>.</span>begin() <span style=color:#66d9ef>as</span> conn:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> conn<span style=color:#f92672>.</span>run_sync(Base<span style=color:#f92672>.</span>metadata<span style=color:#f92672>.</span>create_all)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    logger<span style=color:#f92672>.</span>info(<span style=color:#e6db74>&#34;Done migrating&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>    asyncio<span style=color:#f92672>.</span>run(migrate_tables())
</span></span></code></pre></div><p>To put it simply, the <code>migrate_tables</code> function reads the structure of models and recreates it in the database using the SQLAlchemy engine. To run this script, use the <code>python scripts/migrate.py</code> command.</p><p>The models are now present both in the code and in the database and <code>get_db_session</code> can facilitate interactions with the database. You can now begin working on the API logic.</p><h2 class="relative group">API with the ORM<div id=api-with-the-orm class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#api-with-the-orm aria-label=Anchor>#</a></span></h2><p>As mentioned previously, the API for ingredients and potions is meant to support three operations:</p><ul><li>creating objects</li><li>listing objects</li><li>retrieving objects by ID</li></ul><p>Thanks to the prior preparations, all these features can already be implemented with SQLAlchemy as the ORM and FastAPI as the web framework. To begin, review the ingredients API located in the <code>alchemist/api/v1/routes.py</code> file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> uuid
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> fastapi <span style=color:#f92672>import</span> APIRouter, Depends, HTTPException, status
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> sqlalchemy <span style=color:#f92672>import</span> select
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> sqlalchemy.ext.asyncio <span style=color:#f92672>import</span> AsyncSession
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> alchemist.api <span style=color:#f92672>import</span> models
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> alchemist.database <span style=color:#f92672>import</span> models <span style=color:#66d9ef>as</span> db_models
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> alchemist.database.session <span style=color:#f92672>import</span> get_db_session
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>router <span style=color:#f92672>=</span> APIRouter(prefix<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/v1&#34;</span>, tags<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#34;v1&#34;</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@router.post</span>(<span style=color:#e6db74>&#34;/ingredients&#34;</span>, status_code<span style=color:#f92672>=</span>status<span style=color:#f92672>.</span>HTTP_201_CREATED)
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>create_ingredient</span>(
</span></span><span style=display:flex><span>    data: models<span style=color:#f92672>.</span>IngredientPayload,
</span></span><span style=display:flex><span>    session: AsyncSession <span style=color:#f92672>=</span> Depends(get_db_session),
</span></span><span style=display:flex><span>) <span style=color:#f92672>-&gt;</span> models<span style=color:#f92672>.</span>Ingredient:
</span></span><span style=display:flex><span>    ingredient <span style=color:#f92672>=</span> db_models<span style=color:#f92672>.</span>Ingredient(<span style=color:#f92672>**</span>data<span style=color:#f92672>.</span>dict())
</span></span><span style=display:flex><span>    session<span style=color:#f92672>.</span>add(ingredient)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> session<span style=color:#f92672>.</span>commit()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> session<span style=color:#f92672>.</span>refresh(ingredient)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> models<span style=color:#f92672>.</span>Ingredient<span style=color:#f92672>.</span>from_orm(ingredient)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@router.get</span>(<span style=color:#e6db74>&#34;/ingredients&#34;</span>, status_code<span style=color:#f92672>=</span>status<span style=color:#f92672>.</span>HTTP_200_OK)
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_ingredients</span>(
</span></span><span style=display:flex><span>    session: AsyncSession <span style=color:#f92672>=</span> Depends(get_db_session),
</span></span><span style=display:flex><span>) <span style=color:#f92672>-&gt;</span> list[models<span style=color:#f92672>.</span>Ingredient]:
</span></span><span style=display:flex><span>    ingredients <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> session<span style=color:#f92672>.</span>scalars(select(db_models<span style=color:#f92672>.</span>Ingredient))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> [models<span style=color:#f92672>.</span>Ingredient<span style=color:#f92672>.</span>from_orm(ingredient) <span style=color:#66d9ef>for</span> ingredient <span style=color:#f92672>in</span> ingredients]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@router.get</span>(<span style=color:#e6db74>&#34;/ingredients/</span><span style=color:#e6db74>{pk}</span><span style=color:#e6db74>&#34;</span>, status_code<span style=color:#f92672>=</span>status<span style=color:#f92672>.</span>HTTP_200_OK)
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_ingredient</span>(
</span></span><span style=display:flex><span>    pk: uuid<span style=color:#f92672>.</span>UUID,
</span></span><span style=display:flex><span>    session: AsyncSession <span style=color:#f92672>=</span> Depends(get_db_session),
</span></span><span style=display:flex><span>) <span style=color:#f92672>-&gt;</span> models<span style=color:#f92672>.</span>Ingredient:
</span></span><span style=display:flex><span>    ingredient <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> session<span style=color:#f92672>.</span>get(db_models<span style=color:#f92672>.</span>Ingredient, pk)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ingredient <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> HTTPException(
</span></span><span style=display:flex><span>            status_code<span style=color:#f92672>=</span>status<span style=color:#f92672>.</span>HTTP_404_NOT_FOUND,
</span></span><span style=display:flex><span>            detail<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Ingredient does not exist&#34;</span>,
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> models<span style=color:#f92672>.</span>Ingredient<span style=color:#f92672>.</span>from_orm(ingredient)
</span></span></code></pre></div><p>Under the <code>/ingredients</code> API, there are three routes available. The POST endpoint takes an ingredient payload as an object from a previously created model and a database session. The <code>get_db_session</code> generator function initializes the session and enables database interactions.</p><p>In the actual function body, there are five steps taking place:</p><ol><li>An ingredient object is created from the incoming payload.</li><li>The <code>add</code> method of the session object adds the ingredient object to the session tracking system and marks it as pending for insertion into the database.</li><li>The session is committed.</li><li>The ingredient object is refreshed to ensure its attributes match the database state.</li><li>The database ingredient instance is converted to the API model instance using the <code>from_orm</code> method.</li></ol><p>For a quick test, a simple curl can be executed against the running app:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -X <span style=color:#e6db74>&#39;POST&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  <span style=color:#e6db74>&#39;http://localhost:8000/api/v1/ingredients&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -H <span style=color:#e6db74>&#39;accept: application/json&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -d <span style=color:#e6db74>&#39;{&#34;name&#34;: &#34;Salty water&#34;}&#39;</span>
</span></span></code></pre></div><p>In the response, there should be an ingredient object that has an ID coming from the database:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;pk&#34;</span>:<span style=color:#e6db74>&#34;2eb255e9-2172-4c75-9b29-615090e3250d&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;name&#34;</span>:<span style=color:#e6db74>&#34;Salty water&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Although SQLAlchemy&rsquo;s multiple layers of abstraction may seem unnecessary for a simple API, they keep the ORM details separated and contribute to SQLAlchemy&rsquo;s efficiency and scalability. When combined with asyncio, the ORM features perform exceptionally well in the API.</p><p>The remaining two endpoints are less complex and share similarities. One part that deserves a deeper explanation is the use of the <code>scalars</code> method inside the <code>get_ingredients</code> function. While querying the database using SQLAlchemy, the <code>execute</code> method is often used with a query as the argument. While <code>execute</code> method returns row-like tuples, <code>scalars</code> returns ORM entities directly, making the endpoint cleaner.</p><p>Now, consider the potions API, in the same file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@router.post</span>(<span style=color:#e6db74>&#34;/potions&#34;</span>, status_code<span style=color:#f92672>=</span>status<span style=color:#f92672>.</span>HTTP_201_CREATED)
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>create_potion</span>(
</span></span><span style=display:flex><span>    data: models<span style=color:#f92672>.</span>PotionPayload,
</span></span><span style=display:flex><span>    session: AsyncSession <span style=color:#f92672>=</span> Depends(get_db_session),
</span></span><span style=display:flex><span>) <span style=color:#f92672>-&gt;</span> models<span style=color:#f92672>.</span>Potion:
</span></span><span style=display:flex><span>    data_dict <span style=color:#f92672>=</span> data<span style=color:#f92672>.</span>dict()
</span></span><span style=display:flex><span>    ingredients <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> session<span style=color:#f92672>.</span>scalars(
</span></span><span style=display:flex><span>        select(db_models<span style=color:#f92672>.</span>Ingredient)<span style=color:#f92672>.</span>where(
</span></span><span style=display:flex><span>            db_models<span style=color:#f92672>.</span>Ingredient<span style=color:#f92672>.</span>pk<span style=color:#f92672>.</span>in_(data_dict<span style=color:#f92672>.</span>pop(<span style=color:#e6db74>&#34;ingredients&#34;</span>))
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    potion <span style=color:#f92672>=</span> db_models<span style=color:#f92672>.</span>Potion(<span style=color:#f92672>**</span>data_dict, ingredients<span style=color:#f92672>=</span>list(ingredients))
</span></span><span style=display:flex><span>    session<span style=color:#f92672>.</span>add(potion)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> session<span style=color:#f92672>.</span>commit()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> session<span style=color:#f92672>.</span>refresh(potion)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> models<span style=color:#f92672>.</span>Potion<span style=color:#f92672>.</span>from_orm(potion)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@router.get</span>(<span style=color:#e6db74>&#34;/potions&#34;</span>, status_code<span style=color:#f92672>=</span>status<span style=color:#f92672>.</span>HTTP_200_OK)
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_potions</span>(
</span></span><span style=display:flex><span>    session: AsyncSession <span style=color:#f92672>=</span> Depends(get_db_session),
</span></span><span style=display:flex><span>) <span style=color:#f92672>-&gt;</span> list[models<span style=color:#f92672>.</span>Potion]:
</span></span><span style=display:flex><span>    potions <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> session<span style=color:#f92672>.</span>scalars(select(db_models<span style=color:#f92672>.</span>Potion))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> [models<span style=color:#f92672>.</span>Potion<span style=color:#f92672>.</span>from_orm(potion) <span style=color:#66d9ef>for</span> potion <span style=color:#f92672>in</span> potions]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@router.get</span>(<span style=color:#e6db74>&#34;/potions/</span><span style=color:#e6db74>{pk}</span><span style=color:#e6db74>&#34;</span>, status_code<span style=color:#f92672>=</span>status<span style=color:#f92672>.</span>HTTP_200_OK)
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_potion</span>(
</span></span><span style=display:flex><span>    pk: uuid<span style=color:#f92672>.</span>UUID,
</span></span><span style=display:flex><span>    session: AsyncSession <span style=color:#f92672>=</span> Depends(get_db_session),
</span></span><span style=display:flex><span>) <span style=color:#f92672>-&gt;</span> models<span style=color:#f92672>.</span>Potion:
</span></span><span style=display:flex><span>    potion <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> session<span style=color:#f92672>.</span>get(db_models<span style=color:#f92672>.</span>Potion, pk)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> potion <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> HTTPException(
</span></span><span style=display:flex><span>            status_code<span style=color:#f92672>=</span>status<span style=color:#f92672>.</span>HTTP_404_NOT_FOUND,
</span></span><span style=display:flex><span>            detail<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Potion does not exist&#34;</span>,
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> models<span style=color:#f92672>.</span>Potion<span style=color:#f92672>.</span>from_orm(potion)
</span></span></code></pre></div><p>The GET endpoints for potions are identical to those for ingredients. However, the POST function requires additional code. This is because creating potions involves including at least one ingredient ID, which means that the ingredients must be fetched and linked to the newly created potion. To achieve this, the <code>scalars</code> method is used again, but this time with a query that specifies the IDs of the fetched ingredients. The remaining part of the potion creation process is identical to that of the ingredients.</p><p>To test the endpoint, again a curl command can be executed.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -X <span style=color:#e6db74>&#39;POST&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  <span style=color:#e6db74>&#39;http://localhost:8000/api/v1/potions&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -H <span style=color:#e6db74>&#39;accept: application/json&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -d <span style=color:#e6db74>&#39;{&#34;name&#34;: &#34;Salty soup&#34;, &#34;ingredients&#34;: [&#34;0b4f1de5-e780-418d-a74d-927afe8ac954&#34;}&#39;</span>
</span></span></code></pre></div><p>It results in the following response:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;pk&#34;</span>: <span style=color:#e6db74>&#34;d4929197-3998-4234-a5f7-917dc4bba421&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;Salty soup&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;ingredients&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;pk&#34;</span>: <span style=color:#e6db74>&#34;0b4f1de5-e780-418d-a74d-927afe8ac954&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;Salty water&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>It&rsquo;s important to notice that each ingredient is represented as a complete object within the potion, thanks to the <code>lazy="selectin"</code> argument specified in the relationship.</p><p>The APIs are functional, but there is a major issue with the code. While SQLAlchemy gives you the freedom to interact with the database as you please, it does not offer any high-level &ldquo;manager&rdquo; utility similar to Django&rsquo;s <code>Model.objects</code>. As a result, you will need to create it yourself, which is essentially the logic used in the ingredient and potion APIs. However, if you keep this logic directly in the endpoints without extracting it into a separate space, you will end up with a lot of duplicated code. Additionally, making changes to the queries or models will become increasingly difficult to manage.</p><p>The upcoming chapter introduces the repository pattern: an elegant solution for extracting ORM code.</p><h2 class="relative group">Repository<div id=repository class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#repository aria-label=Anchor>#</a></span></h2><p>The <em><strong>repository</strong></em> pattern allows to abstract away the details of working with the database. In the case of using SQLAlchemy, such as in the example of the alchemist, the repository class would be responsible for managing multiple models and interacting with the database session.</p><p>Take a look at the following code from the <code>alchemist/database/repository.py</code> file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> uuid
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> typing <span style=color:#f92672>import</span> Generic, TypeVar
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> sqlalchemy <span style=color:#f92672>import</span> BinaryExpression, select
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> sqlalchemy.ext.asyncio <span style=color:#f92672>import</span> AsyncSession
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> alchemist.database <span style=color:#f92672>import</span> models
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Model <span style=color:#f92672>=</span> TypeVar(<span style=color:#e6db74>&#34;Model&#34;</span>, bound<span style=color:#f92672>=</span>models<span style=color:#f92672>.</span>Base)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DatabaseRepository</span>(Generic[Model]):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;Repository for performing database queries.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__init__</span>(self, model: type[Model], session: AsyncSession) <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>model <span style=color:#f92672>=</span> model
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>session <span style=color:#f92672>=</span> session
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>create</span>(self, data: dict) <span style=color:#f92672>-&gt;</span> Model:
</span></span><span style=display:flex><span>        instance <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>model(<span style=color:#f92672>**</span>data)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>session<span style=color:#f92672>.</span>add(instance)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> self<span style=color:#f92672>.</span>session<span style=color:#f92672>.</span>commit()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> self<span style=color:#f92672>.</span>session<span style=color:#f92672>.</span>refresh(instance)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> instance
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get</span>(self, pk: uuid<span style=color:#f92672>.</span>UUID) <span style=color:#f92672>-&gt;</span> Model <span style=color:#f92672>|</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> self<span style=color:#f92672>.</span>session<span style=color:#f92672>.</span>get(self<span style=color:#f92672>.</span>model, pk)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>filter</span>(
</span></span><span style=display:flex><span>        self,
</span></span><span style=display:flex><span>        <span style=color:#f92672>*</span>expressions: BinaryExpression,
</span></span><span style=display:flex><span>    ) <span style=color:#f92672>-&gt;</span> list[Model]:
</span></span><span style=display:flex><span>        query <span style=color:#f92672>=</span> select(self<span style=color:#f92672>.</span>model)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> expressions:
</span></span><span style=display:flex><span>            query <span style=color:#f92672>=</span> query<span style=color:#f92672>.</span>where(<span style=color:#f92672>*</span>expressions)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> list(<span style=color:#66d9ef>await</span> self<span style=color:#f92672>.</span>session<span style=color:#f92672>.</span>scalars(query))
</span></span></code></pre></div><p>The <code>DatabaseRepository</code> class holds all the logic that was previously included in the endpoints. The difference is that it allows for the specific model class to be passed in the <code>__init__</code> method, making it possible to reuse the code for all models instead of duplicating it in each endpoint.</p><p>Furthermore, the <code>DatabaseRepository</code> uses Python generics, with the <code>Model</code> generic type bounded to the abstract database model. This allows for the repository class to benefit more from static type checking. When used with a specific model, the return types of the repository methods will reflect this specific model.</p><p>Because the repository needs to use the database session, it must be initialized along with the <code>get_db_session</code> dependency. Consider the new dependency in the <code>alchemist/api/v2/dependencies.py</code> file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> collections.abc <span style=color:#f92672>import</span> Callable
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> fastapi <span style=color:#f92672>import</span> Depends
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> sqlalchemy.ext.asyncio <span style=color:#f92672>import</span> AsyncSession
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> alchemist.database <span style=color:#f92672>import</span> models, repository, session
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_repository</span>(
</span></span><span style=display:flex><span>    model: type[models<span style=color:#f92672>.</span>Base],
</span></span><span style=display:flex><span>) <span style=color:#f92672>-&gt;</span> Callable[[AsyncSession], repository<span style=color:#f92672>.</span>DatabaseRepository]:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>func</span>(session: AsyncSession <span style=color:#f92672>=</span> Depends(session<span style=color:#f92672>.</span>get_db_session)):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> repository<span style=color:#f92672>.</span>DatabaseRepository(model, session)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> func
</span></span></code></pre></div><p>Simply put, the <code>get_repository</code> function is a dependency factory. It first takes the database model that you will use the repository with. Then, it returns the dependency, which will be used to receive the database session and initialize the repository object. To gain a better understanding, check out the new API from the <code>alchemist/api/v2/routes.py</code> file. It shows only the POST endpoints, but it should be enough to give you a clearer idea of how the code gets improved:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> typing <span style=color:#f92672>import</span> Annotated
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> fastapi <span style=color:#f92672>import</span> APIRouter, Depends, status
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> alchemist.api <span style=color:#f92672>import</span> models
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> alchemist.api.v2.dependencies <span style=color:#f92672>import</span> get_repository
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> alchemist.database <span style=color:#f92672>import</span> models <span style=color:#66d9ef>as</span> db_models
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> alchemist.database.repository <span style=color:#f92672>import</span> DatabaseRepository
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>router <span style=color:#f92672>=</span> APIRouter(prefix<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/v2&#34;</span>, tags<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#34;v2&#34;</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>IngredientRepository <span style=color:#f92672>=</span> Annotated[
</span></span><span style=display:flex><span>    DatabaseRepository[db_models<span style=color:#f92672>.</span>Ingredient],
</span></span><span style=display:flex><span>    Depends(get_repository(db_models<span style=color:#f92672>.</span>Ingredient)),
</span></span><span style=display:flex><span>]
</span></span><span style=display:flex><span>PotionRepository <span style=color:#f92672>=</span> Annotated[
</span></span><span style=display:flex><span>    DatabaseRepository[db_models<span style=color:#f92672>.</span>Potion],
</span></span><span style=display:flex><span>    Depends(get_repository(db_models<span style=color:#f92672>.</span>Potion)),
</span></span><span style=display:flex><span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@router.post</span>(<span style=color:#e6db74>&#34;/ingredients&#34;</span>, status_code<span style=color:#f92672>=</span>status<span style=color:#f92672>.</span>HTTP_201_CREATED)
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>create_ingredient</span>(
</span></span><span style=display:flex><span>    data: models<span style=color:#f92672>.</span>IngredientPayload,
</span></span><span style=display:flex><span>    repository: IngredientRepository,
</span></span><span style=display:flex><span>) <span style=color:#f92672>-&gt;</span> models<span style=color:#f92672>.</span>Ingredient:
</span></span><span style=display:flex><span>    ingredient <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> repository<span style=color:#f92672>.</span>create(data<span style=color:#f92672>.</span>dict())
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> models<span style=color:#f92672>.</span>Ingredient<span style=color:#f92672>.</span>from_orm(ingredient)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@router.post</span>(<span style=color:#e6db74>&#34;/potions&#34;</span>, status_code<span style=color:#f92672>=</span>status<span style=color:#f92672>.</span>HTTP_201_CREATED)
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>create_potion</span>(
</span></span><span style=display:flex><span>    data: models<span style=color:#f92672>.</span>PotionPayload,
</span></span><span style=display:flex><span>    ingredient_repository: IngredientRepository,
</span></span><span style=display:flex><span>    potion_repository: PotionRepository,
</span></span><span style=display:flex><span>) <span style=color:#f92672>-&gt;</span> models<span style=color:#f92672>.</span>Potion:
</span></span><span style=display:flex><span>    data_dict <span style=color:#f92672>=</span> data<span style=color:#f92672>.</span>dict()
</span></span><span style=display:flex><span>    ingredients <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> ingredient_repository<span style=color:#f92672>.</span>filter(
</span></span><span style=display:flex><span>        db_models<span style=color:#f92672>.</span>Ingredient<span style=color:#f92672>.</span>pk<span style=color:#f92672>.</span>in_(data_dict<span style=color:#f92672>.</span>pop(<span style=color:#e6db74>&#34;ingredients&#34;</span>))
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    potion <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> potion_repository<span style=color:#f92672>.</span>create({<span style=color:#f92672>**</span>data_dict, <span style=color:#e6db74>&#34;ingredients&#34;</span>: ingredients})
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> models<span style=color:#f92672>.</span>Potion<span style=color:#f92672>.</span>from_orm(potion)
</span></span></code></pre></div><p>The first important feature to note is the use of <code>Annotated</code>, a new way of working with FastAPI dependencies. By specifying the dependency&rsquo;s return type as <code>DatabaseRepository[db_models.Ingredient]</code> and declaring its usage with <code>Depends(get_repository(db_models.Ingredient))</code> you can end up using simple type annotations in the endpoint: <code>repository: IngredientRepository</code>.</p><p>Thanks to the repository, the endpoints don&rsquo;t have to store all the ORM-related burden. Even in the more complicated potion case, all you need to do is to use two repositories at the same time.</p><p>You may wonder if initializing two repositories will initialize the session twice. The answer is no. FastAPI dependency system caches the same dependency calls in a single request. This means that session initialization gets cached and both repositories use the exact same session object. Yet another great feature of the combination of SQLAlchemy and FastAPI.</p><p>The API is fully functional and has a reusable, high-performing data-access layer. The next step is to make sure the requirements are met by writing some end-to-end tests.</p><h2 class="relative group">Testing<div id=testing class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#testing aria-label=Anchor>#</a></span></h2><p>Tests play a crucial role in software development. Projects can contain unit, integration, and end-to-end (E2E) tests. While it is usually best to have a high number of meaningful unit tests, it is also good to write at least a few E2E tests to ensure the entire workflow is functioning correctly.</p><p>To create some E2E tests for the alchemist app, two additional libraries are required:</p><ul><li>pytest to actually create and run the tests</li><li>httpx to make async requests inside the tests</li></ul><p>Once these are installed, the next step is to have a separate, test database in place. You don&rsquo;t want your default database to be polluted or dropped. Since alchemist includes a Docker setup, only a simple script is needed to create a second database. Take a look at the code from the <code>scripts/create_test_db.sh</code> file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>psql -U postgres
</span></span><span style=display:flex><span>psql -c <span style=color:#e6db74>&#34;CREATE DATABASE test&#34;</span>
</span></span></code></pre></div><p>In order for the script to be executed, it must be added as a volume to the Postgres container. This can be achieved by including it in the <code>volumes</code> section of the <code>docker-compose.yaml</code> file.</p><p>The final step of preparation is to create pytest fixtures within the <code>tests/conftest.py</code> file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> collections.abc <span style=color:#f92672>import</span> AsyncGenerator
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> pytest
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> pytest_asyncio
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> fastapi <span style=color:#f92672>import</span> FastAPI
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> httpx <span style=color:#f92672>import</span> AsyncClient
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> sqlalchemy.ext.asyncio <span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    AsyncSession,
</span></span><span style=display:flex><span>    async_sessionmaker,
</span></span><span style=display:flex><span>    create_async_engine,
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> alchemist.app <span style=color:#f92672>import</span> app
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> alchemist.config <span style=color:#f92672>import</span> settings
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> alchemist.database.models <span style=color:#f92672>import</span> Base
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> alchemist.database.session <span style=color:#f92672>import</span> get_db_session
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@pytest_asyncio.fixture</span>()
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>db_session</span>() <span style=color:#f92672>-&gt;</span> AsyncGenerator[AsyncSession, <span style=color:#66d9ef>None</span>]:
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;Start a test database session.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    db_name <span style=color:#f92672>=</span> settings<span style=color:#f92672>.</span>DATABASE_URL<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#34;/&#34;</span>)[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>    db_url <span style=color:#f92672>=</span> settings<span style=color:#f92672>.</span>DATABASE_URL<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;/</span><span style=color:#e6db74>{</span>db_name<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;/test&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    engine <span style=color:#f92672>=</span> create_async_engine(db_url)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>with</span> engine<span style=color:#f92672>.</span>begin() <span style=color:#66d9ef>as</span> conn:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> conn<span style=color:#f92672>.</span>run_sync(Base<span style=color:#f92672>.</span>metadata<span style=color:#f92672>.</span>drop_all)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> conn<span style=color:#f92672>.</span>run_sync(Base<span style=color:#f92672>.</span>metadata<span style=color:#f92672>.</span>create_all)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    session <span style=color:#f92672>=</span> async_sessionmaker(engine)()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>yield</span> session
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> session<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@pytest.fixture</span>()
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_app</span>(db_session: AsyncSession) <span style=color:#f92672>-&gt;</span> FastAPI:
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;Create a test app with overridden dependencies.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    app<span style=color:#f92672>.</span>dependency_overrides[get_db_session] <span style=color:#f92672>=</span> <span style=color:#66d9ef>lambda</span>: db_session
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> app
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@pytest_asyncio.fixture</span>()
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>client</span>(test_app: FastAPI) <span style=color:#f92672>-&gt;</span> AsyncGenerator[AsyncClient, <span style=color:#66d9ef>None</span>]:
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;Create an http client.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>with</span> AsyncClient(app<span style=color:#f92672>=</span>test_app, base_url<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://test&#34;</span>) <span style=color:#66d9ef>as</span> client:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>yield</span> client
</span></span></code></pre></div><p>One thing that is essential to be changed in the tests, is how the app interacts with the database. This includes not only changing the database URL but also ensuring that each test is isolated by starting with an empty database.</p><p>The <code>db_session</code> fixture accomplishes both of these goals. Its body takes the following steps:</p><ol><li>Create an engine with a modified database URL.</li><li>Delete all existing tables to make sure that the test has a clean database.</li><li>Create all the tables inside the database (same code as in the migration script).</li><li>Create and yield a session object.</li><li>Manually close the session when the test is done.</li></ol><p>Although the last step could also be implemented as a context manager, manual closing works just fine in this case.</p><p>The two remaining fixtures should be quite self-explanatory:</p><ul><li><code>test_app</code> is the FastAPI instance from the <code>alchemist/app.py</code> file, with the <code>get_db_session</code> dependency replaced with the <code>db_session</code> fixture</li><li><code>client</code> is the httpx <code>AsyncClient</code> that will make API requests against the <code>test_app</code></li></ul><p>With all this being set up, finally the actual tests can be written. For conciseness, the example below from the <code>tests/test_api.py</code> file shows only a test for creating an ingredient:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> fastapi <span style=color:#f92672>import</span> status
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TestIngredientsAPI</span>:
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;Test cases for the ingredients API.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_create_ingredient</span>(self, client):
</span></span><span style=display:flex><span>        response <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> client<span style=color:#f92672>.</span>post(<span style=color:#e6db74>&#34;/api/v2/ingredients&#34;</span>, json<span style=color:#f92672>=</span>{<span style=color:#e6db74>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;Carrot&#34;</span>})
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>assert</span> response<span style=color:#f92672>.</span>status_code <span style=color:#f92672>==</span> status<span style=color:#f92672>.</span>HTTP_201_CREATED
</span></span><span style=display:flex><span>        pk <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span>json()<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;pk&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>assert</span> pk <span style=color:#f92672>is</span> <span style=color:#f92672>not</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        response <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> client<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;/api/v2/ingredients&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>assert</span> response<span style=color:#f92672>.</span>status_code <span style=color:#f92672>==</span> status<span style=color:#f92672>.</span>HTTP_200_OK
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>assert</span> len(response<span style=color:#f92672>.</span>json()) <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>assert</span> response<span style=color:#f92672>.</span>json()[<span style=color:#ae81ff>0</span>][<span style=color:#e6db74>&#34;pk&#34;</span>] <span style=color:#f92672>==</span> pk
</span></span></code></pre></div><p>The test uses a client object created in a fixture, that makes requests to the FastAPI instance with overridden dependency. As a result, the test is able to interact with a separate database that will be cleared after the test is done. The structure of the remaining test suite for both APIs is pretty much the same.</p><h2 class="relative group">Summary<div id=summary class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#summary aria-label=Anchor>#</a></span></h2><p>FastAPI and SQLAlchemy are excellent technologies for creating modern and powerful backend applications. The freedom, simplicity, and flexibility they offer make them one of the best options for Python-based projects. If developers follow best practices and patterns, they can create performant, robust, and well-structured applications that handle database operations and API logic with ease. This article aimed to provide you with a good understanding of how to set up and maintain this amazing combination.</p><h2 class="relative group">Sources<div id=sources class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#sources aria-label=Anchor>#</a></span></h2><p>The source code for the alchemist project can be found here:</p><div class=github-card-wrapper><a id=github-2aa8afdf581bf71d3b5d43ff3491d07a target=_blank href=https://github.com/ttyobiwan/alchemist class=cursor-pointer><div class="w-full md:w-auto p-0 m-0 border border-neutral-200 dark:border-neutral-700 border rounded-md shadow-2xl"><div class="w-full nozoom"><img src=https://opengraph.githubassets.com/0/ttyobiwan/alchemist alt="GitHub Repository Thumbnail" class="nozoom mt-0 mb-0 w-full h-full object-cover"></div><div class="w-full md:w-auto pt-3 p-5"><div class="flex items-center"><span class="text-2xl text-neutral-800 dark:text-neutral me-2"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></span><div id=github-2aa8afdf581bf71d3b5d43ff3491d07a-full_name class="m-0 font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral">ttyobiwan/alchemist</div></div><p id=github-2aa8afdf581bf71d3b5d43ff3491d07a-description class="m-0 mt-2 text-md text-neutral-800 dark:text-neutral">Code examples for the SQLAlchemy article</p><div class="m-0 mt-2 flex items-center"><span class="mr-1 inline-block h-3 w-3 rounded-full language-dot" data-language=Python></span><div class="m-0 mr-5 text-md text-neutral-800 dark:text-neutral">Python</div><span class="text-md mr-1 text-neutral-800 dark:text-neutral"><span class="relative block icon"><svg viewBox="0 0 576 512"><path fill="currentColor" d="M287.9.0C297.1.0 305.5 5.25 309.5 13.52L378.1 154.8l153.3 22.7C540.4 178.8 547.8 185.1 550.7 193.7 553.5 202.4 551.2 211.9 544.8 218.2L433.6 328.4l26.3 155.5C461.4 492.9 457.7 502.1 450.2 507.4 442.8 512.7 432.1 513.4 424.9 509.1L287.9 435.9 150.1 509.1C142.9 513.4 133.1 512.7 125.6 507.4 118.2 502.1 114.5 492.9 115.1 483.9l27.1-155.5L31.11 218.2C24.65 211.9 22.36 202.4 25.2 193.7 28.03 185.1 35.5 178.8 44.49 177.5L197.7 154.8 266.3 13.52C270.4 5.249 278.7.0 287.9.0zm0 78.95L235.4 187.2C231.9 194.3 225.1 199.3 217.3 200.5L98.98 217.9 184.9 303C190.4 308.5 192.9 316.4 191.6 324.1L171.4 443.7l105.2-56.2C283.7 383.7 292.2 383.7 299.2 387.5l105.2 56.2-20.2-119.6C382.9 316.4 385.5 308.5 391 303l85.9-85.1-118.3-17.4C350.7 199.3 343.9 194.3 340.5 187.2L287.9 78.95z"/></svg></span></span><div id=github-2aa8afdf581bf71d3b5d43ff3491d07a-stargazers class="m-0 mr-5 text-md text-neutral-800 dark:text-neutral">56</div><span class="text-md mr-1 text-neutral-800 dark:text-neutral"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M80 104c13.3.0 24-10.7 24-24S93.3 56 80 56 56 66.7 56 80s10.7 24 24 24zm80-24c0 32.8-19.7 61-48 73.3V192c0 17.7 14.3 32 32 32H304c17.7.0 32-14.3 32-32V153.3C307.7 141 288 112.8 288 80c0-44.2 35.8-80 80-80s80 35.8 80 80c0 32.8-19.7 61-48 73.3V192c0 53-43 96-96 96H256v70.7c28.3 12.3 48 40.5 48 73.3.0 44.2-35.8 80-80 80s-80-35.8-80-80c0-32.8 19.7-61 48-73.3V288H144c-53 0-96-43-96-96V153.3C19.7 141 0 112.8.0 80 0 35.8 35.8.0 80 0s80 35.8 80 80zm208 24c13.3.0 24-10.7 24-24s-10.7-24-24-24-24 10.7-24 24 10.7 24 24 24zM248 432c0-13.3-10.7-24-24-24s-24 10.7-24 24 10.7 24 24 24 24-10.7 24-24z"/></svg></span></span><div id=github-2aa8afdf581bf71d3b5d43ff3491d07a-forks class="m-0 mr-5 text-md text-neutral-800 dark:text-neutral">13</div></div></div></div><script async type=text/javascript src=/js/fetch-repo.min.dc5533c50cefd50405344b235937142271f26229fe39cbee27fd4960e8bb897a0beebfad77a1091ca91cd0d1fb14e70fc37cc114dd9674fb2c32e0ab512ec8a4.js integrity="sha512-3FUzxQzv1QQFNEsjWTcUInHyYin+OcvuJ/1JYOi7iXoL7r+td6EJHKkc0NH7FOcPw3zBFN2WdPssMuCrUS7IpA==" data-repo-url=https://api.github.com/repos/ttyobiwan/alchemist data-repo-id=github-2aa8afdf581bf71d3b5d43ff3491d07a></script></a></div></div></div><script type=text/javascript src=/js/page.min.54b6f4371722649edbe871e431d8670d670878c22be8f36e229fe53cc9b786fe25a834def5e6de621f7a3e37b72bc8cd73839aa5ed907ed6cbd45cd3e1b0fa20.js integrity="sha512-VLb0NxciZJ7b6HHkMdhnDWcIeMIr6PNuIp/lPMm3hv4lqDTe9ebeYh96Pje3K8jNc4Oape2QftbL1FzT4bD6IA==" data-oid=views_articles/fastapi-sqlalchemy/index.md data-oid-likes=likes_articles/fastapi-sqlalchemy/index.md></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group mr-3" href=/articles/sigmapython02/><span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Sigma Python #2: Generators</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2023-05-23T00:00:00+00:00>23 May 2023</time>
</span></span></a></span><span><a class="flex text-right group ml-3" href=/articles/sigmapython03/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Sigma Python #3: Descriptors</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2023-07-13T00:00:00+00:00>13 July 2023</time>
</span></span><span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&larr;</span></a></span></div></div></footer></article><div id=top-scroller class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0 z-10"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2025
Piotr Tobiasz</p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://blowfish.page/ target=_blank rel="noopener noreferrer">Blowfish</a></p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh+sCQ0E53ghYrxgYqw+0GCRyIEpA=="></script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh] z-500" data-url=https://ttyobiwan.github.io/><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>